# Web Application Implementation Plan - Basin Analytics Agent

## Overview

Transform the CLI analytics agent into a web application accessible to the entire Basin Climbing team.

---

## User Requirements

### Core Functionality
1. **Chat Interface**
   - Start a chat session
   - Ask questions back-and-forth
   - Receive answers from analytics agent
   - Persistent conversation history

2. **Chart Viewing**
   - Display charts generated by agent
   - Save charts for later viewing
   - Gallery/library of generated charts

3. **Feedback Collection**
   - Dropdown/form for team feedback
   - Store feedback in S3 bucket
   - Plain text format, retrievable later

4. **Session Learnings Storage**
   - Save insights/learnings from conversations
   - Don't need full conversation transcripts
   - Store in S3 bucket

### Future Considerations
- Login/authentication (not now, but influences hosting choice)
- Multi-user support

---

## Hosting Options Analysis

### Option 1: Streamlit (RECOMMENDED) âœ…

**Pros:**
- **Fastest to build**: Built for data apps, minimal boilerplate
- **Free hosting**: Streamlit Community Cloud (free tier)
- **Built-in chat UI**: `st.chat_message()`, `st.chat_input()`
- **Easy charts**: Native Plotly support
- **Authentication ready**: Streamlit has built-in auth (coming soon) or use `streamlit-authenticator`
- **Python-native**: Reuse all existing code
- **Session state**: Built-in session management
- **File uploads/downloads**: Native support
- **Deployment**: One-click deploy from GitHub

**Cons:**
- Less customizable UI than full web framework
- Can be slow with very large datasets (not an issue for you)

**Estimated Build Time**: 4-6 hours

**Deployment**:
```bash
# Deploy to Streamlit Cloud (free)
streamlit run app.py --server.port 8501
```

**Authentication Options**:
- `streamlit-authenticator` library (username/password)
- Google OAuth via `streamlit-google-auth`
- Custom auth with session state

---

### Option 2: Heroku with Flask/FastAPI

**Pros:**
- More control over UI/UX
- Can use any frontend framework (React, etc.)
- Scalable
- Professional deployment

**Cons:**
- **Heroku no longer has free tier** (min $5-7/month)
- More code to write (backend + frontend)
- Need to handle WebSockets for real-time chat
- More complex deployment

**Estimated Build Time**: 12-16 hours

---

### Option 3: Railway / Render (Heroku Alternatives)

**Pros:**
- Free tiers available (Railway: $5 credit/month, Render: 750 hours/month free)
- Modern deployment
- Dockerfile support

**Cons:**
- Same complexity as Heroku option
- Still need to build full frontend

**Estimated Build Time**: 12-16 hours

---

## RECOMMENDATION: Streamlit

**Why:**
1. **Speed**: 4-6 hours vs 12-16 hours
2. **Cost**: Free forever on Streamlit Cloud
3. **Perfect fit**: Built for exactly this use case (data analytics chat)
4. **Authentication ready**: Easy to add later
5. **Team familiarity**: Simple enough for non-developers to use
6. **Proven**: Used by many companies for internal analytics tools

---

## Streamlit Implementation Plan

### Architecture

```
streamlit_app.py (main app)
â”œâ”€â”€ Chat Interface (st.chat_message, st.chat_input)
â”œâ”€â”€ Chart Gallery (st.image, st.plotly_chart)
â”œâ”€â”€ Feedback Form (st.text_area, st.button)
â””â”€â”€ Session Storage (S3 integration)

agent/ (existing code - reuse!)
â”œâ”€â”€ main_agent.py (analytics agent)
â”œâ”€â”€ analytics_tools.py (chart generation)
â””â”€â”€ ...

utils/
â”œâ”€â”€ s3_storage.py (feedback & learnings storage)
â””â”€â”€ chart_manager.py (chart saving/loading)
```

---

## Feature Breakdown

### Feature 1: Chat Interface

**UI Components:**
```python
import streamlit as st
from agent.main_agent import AnalyticsAgent

# Initialize agent in session state
if "agent" not in st.session_state:
    st.session_state.agent = AnalyticsAgent()
    st.session_state.messages = []

# Display chat history
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])
        if "chart" in message:
            st.plotly_chart(message["chart"])

# Chat input
if prompt := st.chat_input("Ask about Basin's analytics..."):
    # Add user message
    st.session_state.messages.append({"role": "user", "content": prompt})

    # Get agent response
    response = st.session_state.agent.chat(prompt)

    # Add assistant message
    st.session_state.messages.append({
        "role": "assistant",
        "content": response.text,
        "chart": response.chart if response.has_chart else None
    })

    st.rerun()
```

**Features:**
- Persistent conversation within session
- Display both text and charts inline
- Scroll history
- Clear chat button

---

### Feature 2: Chart Gallery

**Implementation:**
```python
# Sidebar: Chart Gallery
with st.sidebar:
    st.header("ğŸ“Š Chart Gallery")

    if st.button("View All Charts"):
        st.session_state.show_gallery = True

    # Show recent charts
    recent_charts = get_recent_charts_from_s3(limit=5)
    for chart in recent_charts:
        with st.expander(f"{chart.title} - {chart.date}"):
            st.plotly_chart(chart.figure)
            st.download_button("Download", chart.html)
```

**Storage Strategy:**
- Save each chart to S3: `s3://bucket/charts/{date}_{chart_id}.html`
- Metadata in S3: `s3://bucket/charts/metadata.json`
```json
{
  "chart_id": "20251031_revenue_trend",
  "title": "Revenue Trend - Last 30 Days",
  "created_at": "2025-10-31T10:30:00",
  "created_by": "user@basin.com",
  "s3_path": "charts/20251031_revenue_trend.html",
  "thumbnail": "charts/thumbs/20251031_revenue_trend.png"
}
```

**Features:**
- Gallery view (grid of chart thumbnails)
- Search/filter by date or topic
- Download chart as HTML or image
- Delete old charts

---

### Feature 3: Feedback Collection

**UI Component:**
```python
# Sidebar: Feedback Form
with st.sidebar:
    st.header("ğŸ’¬ Feedback")

    with st.form("feedback_form"):
        feedback_type = st.selectbox(
            "Feedback Type",
            ["Bug Report", "Feature Request", "Agent Response Quality", "Other"]
        )

        feedback_text = st.text_area(
            "Your feedback",
            placeholder="Tell us what you think...",
            height=150
        )

        submitted = st.form_submit_button("Submit Feedback")

        if submitted and feedback_text:
            save_feedback_to_s3(
                feedback_type=feedback_type,
                text=feedback_text,
                user=st.session_state.get("user", "anonymous"),
                timestamp=datetime.now()
            )
            st.success("Thank you for your feedback!")
```

**Storage Format (S3):**
```
s3://bucket/feedback/
â”œâ”€â”€ 2025-10-31_feedback.jsonl  (daily file, append-only)
â””â”€â”€ metadata.json
```

**JSONL Format** (one JSON object per line):
```jsonl
{"timestamp": "2025-10-31T10:30:00", "user": "steel@basin.com", "type": "Bug Report", "text": "Agent gave wrong revenue number for Oct 15"}
{"timestamp": "2025-10-31T11:45:00", "user": "jane@basin.com", "type": "Feature Request", "text": "Would love to see member retention rates"}
```

**Why JSONL?**
- Easy to append (no need to parse entire file)
- Each line is valid JSON (easy to process)
- Can stream large files
- Standard format for logs/feedback

---

### Feature 4: Session Learnings Storage

**What to Store:**
- Key insights from conversation
- Questions asked
- Charts generated
- Recommendations given
- User decisions/actions

**Storage Format:**
```
s3://bucket/session_learnings/
â”œâ”€â”€ 2025-10-31/
â”‚   â”œâ”€â”€ session_12345.json
â”‚   â”œâ”€â”€ session_12346.json
â””â”€â”€ summary_2025-10.json (monthly rollup)
```

**Session Learning Schema:**
```json
{
  "session_id": "12345",
  "date": "2025-10-31",
  "user": "steel@basin.com",
  "duration_minutes": 15,
  "questions_asked": [
    "What was revenue in October?",
    "Which membership type grew the most?"
  ],
  "insights_discovered": [
    "October revenue was $45K, up 12% from September",
    "Day passes grew 25%, memberships grew 8%"
  ],
  "charts_generated": [
    "revenue_trend_oct_2025",
    "membership_growth_comparison"
  ],
  "agent_recommendations": [
    "Consider promoting day passes more heavily",
    "Investigate why membership growth is slower"
  ],
  "user_actions": [
    "Saved chart: revenue_trend_oct_2025",
    "Requested follow-up analysis on day pass trends"
  ]
}
```

**Extraction Strategy:**
Use LLM to summarize conversation at end of session:
```python
def extract_learnings_from_session(messages):
    """Use Claude to extract key learnings from conversation"""
    conversation_text = "\n".join([
        f"{msg['role']}: {msg['content']}"
        for msg in messages
    ])

    prompt = f"""Analyze this analytics conversation and extract:
1. Questions asked by user
2. Key insights discovered
3. Charts generated
4. Agent recommendations
5. User decisions/actions

Conversation:
{conversation_text}

Return as JSON with keys: questions_asked, insights_discovered, charts_generated, agent_recommendations, user_actions
"""

    response = anthropic_client.messages.create(
        model="claude-3-haiku-20240307",
        max_tokens=1000,
        messages=[{"role": "user", "content": prompt}]
    )

    return parse_json(response.content)
```

**When to Save:**
- User clicks "End Session" button
- Session idle for 30+ minutes (auto-save)
- User closes browser (beforeunload event)

---

## File Structure

```
agent-assisted-basin-climbing-dashboard/
â”œâ”€â”€ streamlit_app.py              # Main Streamlit app
â”œâ”€â”€ pages/                         # Multi-page app
â”‚   â”œâ”€â”€ 1_ğŸ’¬_Chat.py              # Chat interface (default)
â”‚   â”œâ”€â”€ 2_ğŸ“Š_Chart_Gallery.py     # View all charts
â”‚   â”œâ”€â”€ 3_ğŸ“š_Learnings.py         # Browse session learnings
â”‚   â””â”€â”€ 4_âš™ï¸_Settings.py          # App settings
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ streamlit_helpers.py      # UI components
â”‚   â”œâ”€â”€ s3_storage.py             # S3 feedback/learnings storage
â”‚   â”œâ”€â”€ chart_manager.py          # Chart save/load/display
â”‚   â””â”€â”€ session_manager.py        # Session learnings extraction
â”œâ”€â”€ agent/                         # Existing agent code (reuse!)
â”‚   â”œâ”€â”€ main_agent.py
â”‚   â”œâ”€â”€ analytics_tools.py
â”‚   â””â”€â”€ ...
â”œâ”€â”€ .streamlit/
â”‚   â””â”€â”€ config.toml                # Streamlit config
â”œâ”€â”€ requirements.txt               # Add streamlit
â””â”€â”€ README.md
```

---

## Implementation Phases

### Phase 1: Basic Chat Interface (2 hours)
- Set up Streamlit app structure
- Integrate existing analytics agent
- Chat UI with message history
- Display text responses

**Deliverable**: Working chat interface, can ask questions and get answers

---

### Phase 2: Chart Display & Gallery (1.5 hours)
- Display charts inline in chat
- Save charts to S3 when generated
- Chart gallery sidebar
- Download chart functionality

**Deliverable**: Charts appear in conversation, can view/download past charts

---

### Phase 3: Feedback Collection (1 hour)
- Feedback form in sidebar
- Save to S3 in JSONL format
- Success confirmation
- View recent feedback (admin only)

**Deliverable**: Team can submit feedback, stored in S3

---

### Phase 4: Session Learnings Storage (1.5 hours)
- Extract learnings using LLM at session end
- Save to S3
- "End Session" button
- Browse past learnings page

**Deliverable**: Automatic learning extraction and storage

---

### Phase 5: Deployment & Testing (1 hour)
- Deploy to Streamlit Cloud
- Test with team
- Fix any bugs
- Add basic auth (optional)

**Deliverable**: Live app accessible to team

---

## Authentication (Future - Not Phase 1)

### Option A: Streamlit Built-in Auth (Simplest)
```python
# .streamlit/config.toml
[server]
enableCORS = false
enableXsrfProtection = true

# Simple password protection
import streamlit_authenticator as stauth

authenticator = stauth.Authenticate(
    credentials={'usernames': {
        'steel': {'name': 'Steel Ferguson', 'password': hash_password('password123')},
        'jane': {'name': 'Jane Doe', 'password': hash_password('password456')}
    }},
    cookie_name='basin_analytics',
    key='basin_secret_key',
    cookie_expiry_days=30
)

name, authentication_status, username = authenticator.login('Login', 'main')

if authentication_status:
    st.write(f'Welcome *{name}*')
    # Rest of app
elif authentication_status == False:
    st.error('Username/password is incorrect')
```

### Option B: Google OAuth (More Professional)
```python
# Use streamlit-google-auth
from streamlit_google_auth import Authenticate

authenticator = Authenticate(
    secret_credentials_path='google_credentials.json',
    cookie_name='basin_analytics_auth',
    cookie_key='basin_secret',
    redirect_uri='https://your-app.streamlit.app'
)

authenticator.check_authentification()
authenticator.login()

if st.session_state['connected']:
    st.write(f"Hello {st.session_state['user_info']['name']}")
    # Rest of app
```

---

## Deployment Instructions

### Streamlit Cloud (Free)

1. **Push code to GitHub**
   ```bash
   git add .
   git commit -m "Add Streamlit web app"
   git push origin main
   ```

2. **Deploy on Streamlit Cloud**
   - Go to https://share.streamlit.io/
   - Click "New app"
   - Select repo: `your-username/agent-assisted-basin-climbing-dashboard`
   - Main file: `streamlit_app.py`
   - Click "Deploy"

3. **Set Environment Variables** (in Streamlit Cloud settings)
   ```
   AWS_ACCESS_KEY_ID=your_key
   AWS_SECRET_ACCESS_KEY=your_secret
   ANTHROPIC_API_KEY=your_key
   INSTAGRAM_ACCESS_TOKEN=your_token
   # etc.
   ```

4. **Custom Domain** (optional)
   - Default: `https://your-app.streamlit.app`
   - Custom: Configure CNAME to point to Streamlit

---

## Cost Estimate

### Streamlit Cloud (Free Tier)
- **Hosting**: Free forever
- **Limits**:
  - 1 private app (unlimited public apps)
  - 1 GB RAM
  - 1 CPU
  - Sleeps after inactivity (wakes in ~10 seconds)

**If you need more**:
- Streamlit Cloud Pro: $20/month/user
- Always-on apps, more resources

### AWS S3 Storage (Feedback & Learnings)
- **Feedback**: ~1MB/year = $0.023/year
- **Session Learnings**: ~10MB/year = $0.23/year
- **Charts**: ~100MB/year = $2.30/year
- **Total**: ~$2.55/year

### LLM Costs (Session Learning Extraction)
- Using Claude 3 Haiku: ~$0.001 per session summary
- 100 sessions/month: $0.10/month = $1.20/year

**Total Annual Cost**: ~$3.75/year (negligible)

---

## Security Considerations

### Current (No Auth)
- Anyone with URL can access
- OK for internal testing
- Not OK for production with sensitive data

### With Auth (Phase 2)
- Username/password or Google OAuth
- Session-based authentication
- HTTPS by default (Streamlit Cloud)
- Secrets managed in Streamlit Cloud settings

### Data Security
- S3 bucket: Private (not public)
- Environment variables: Encrypted in Streamlit Cloud
- API keys: Never exposed to client
- HTTPS: All traffic encrypted

---

## Success Metrics

After deployment, track:
1. **Usage**: Number of sessions per week
2. **Engagement**: Questions asked per session
3. **Charts**: Charts generated and saved
4. **Feedback**: Feedback submissions per week
5. **Value**: Time saved vs. manual SQL queries

---

## Timeline

**Total Estimated Time**: 7 hours

- **Phase 1** (Chat): 2 hours
- **Phase 2** (Charts): 1.5 hours
- **Phase 3** (Feedback): 1 hour
- **Phase 4** (Learnings): 1.5 hours
- **Phase 5** (Deploy): 1 hour

**Realistic Timeline**: 2 working days (with testing/iteration)

---

## Next Steps

1. **Approve this plan** or suggest modifications
2. **Start Phase 1**: Basic chat interface
3. **Test locally**: `streamlit run streamlit_app.py`
4. **Iterate**: Get your feedback, refine
5. **Deploy**: Push to Streamlit Cloud
6. **Add team**: Share URL with teammates
7. **Collect feedback**: See what features they want
8. **Iterate**: Add authentication, more features

After web app is live, return to:
- Facebook/Instagram Ads integration
- Mailchimp integration

---

## Questions Before We Start

1. **Hosting preference confirmed?** Streamlit Cloud (free) vs paid option?
2. **Authentication timing?** Add now or later?
3. **Team size?** How many people will use this?
4. **Public vs private?** Should app be public or require login?
5. **Custom domain?** Want `analytics.basinclimbing.com` or OK with `basin-analytics.streamlit.app`?

Let me know and I'll start building!
